#!/bin/bash

PATH=.:$(dirname $0):/usr/lib:$PATH
. liblinuxlive || exit 1

. /etc/slitaz/slitaz.conf
ISODIR="$SLITAZ_DIR/slitaz-modular/$PROFILE/iso"
PKGLIST="$SLITAZ_DIR/slitaz-modular/$PROFILE/packages.list"
INSTALL_FILES="receipt files.list md5sum volatile.cpio.gz"

if [ "$1" = "" ]; then
   echo
   echo "Convert package into .xz compressed module"
   echo "usage: $0 pkgname"
   exit 1
fi

if [ -d "$2" ]; then
	CUR_DIR="$2"
else
	CUR_DIR="$PWD"
fi

tmp_dir=/tmp/taz2xz-$$
mkdir -p $tmp_dir
cd $tmp_dir

tazpkg get $1 || exit 1
PACKAGE_FILE="$(find -name "$1-*.tazpkg")"
{ cpio --quiet -i receipt > /dev/null 2>&1; } < $PACKAGE_FILE
source receipt || exit 1
PACKAGE="${PACKAGE}-${VERSION}${EXTRAVERSION}"
tazpkg extract $PACKAGE.tazpkg
for i in $INSTALL_FILES; do
	if [ -f "$PACKAGE/$i" ]; then
		mkdir -p $PACKAGE/fs/$INSTALLED/$PACKAGE
		cp -a $PACKAGE/$i $PACKAGE/fs/$INSTALLED/$PACKAGE/$i
	fi
done
md5sum $PACKAGE.tazpkg > $PACKAGE/fs/$INSTALLED/$PACKAGE/pkgmd5
create_module $PACKAGE/fs $CUR_DIR/$PACKAGE.xz -comp xz -Xbcj x86

cd $CUR_DIR
rm -rf $tmp_dir
#[ -f $tmp_dir/receipt ] && rm -rf $tmp_dir/receipt
#[ -d $tmp_dir/$PACKAGE-$VERSION ] && rm -rf $tmp_dir/$PACKAGE-$VERSION
#[ -f $tmp_dir/$PACKAGE-$VERSION.tazpkg ] & rm -rf $tmp_dir/$PACKAGE-$VERSION.tazpkg

