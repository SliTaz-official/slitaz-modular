# /etc/lighttpd/vhosts.conf : Virtual hosts configuration file.
#

# Nice url's for Drupal
#
#url.rewrite-final = (
#  "^/system/test/(.*)$" => "/index.php?q=system/test/$1",
#  "^/([^.?]*)\?(.*)$" => "/index.php?q=$1&$2",
#  "^/([^.?]*)$" => "/index.php?q=$1",
#   "^/rss.xml" => "/index.php?q=rss.xml"
#  )

include "common.conf"

# tank.slitaz.org (Server canonical hostname)
#
$HTTP["host"] =~ "tank\.slitaz\.org$" {
  server.name = "tank"
  server.document-root = basedir + server.name
  server.errorlog = logdir + "localhost-tank-error.log"
  accesslog.filename = logdir + "localhost-tank-access.log"
  include "awstats.conf"
  index-file.names += ( "index.php" )
}

# slitaz.org
#
$HTTP["host"] =~ "(^|www\.)slitaz\.org$" {
  server.name = "website"
  server.document-root = basedir + server.name
  server.errorlog = logdir + "slitaz.org-error.log"
  accesslog.filename = logdir + "slitaz.org-access.log"
  
  include "awstats.conf"
  index-file.names += ( "index.php" )
  index-file.names += ( "index.html" )
  
  url.rewrite-once = (
    "^/about" => "/fr/about",
	"^/artwork" => "/fr/artwork",
	"^/devel" => "/fr/devel",
    "^/doc" => "/fr/doc",
	"^/get" => "/fr/get",
	"^/packages" => "/fr/packages"
  )
 
}

# pro.slitaz.org
#
$HTTP["host"] =~ "pro\.slitaz\.org$" {
  server.name = "pro"
  server.document-root = basedir + server.name
  server.errorlog = logdir + "pro.slitaz.org-error.log"
  accesslog.filename = logdir + "pro.slitaz.org-access.log"
  url.rewrite-final = (
    "^/system/test/(.*)$" => "/index.php?q=system/test/$1",
    "^/([^.?]*)\?(.*)$" => "/index.php?q=$1&$2",
    "^/([^.?]*)$" => "/index.php?q=$1",
    "^/rss.xml" => "/index.php?q=rss.xml"
  )
}

# people.slitaz.org
#
$HTTP["host"] =~ "people\.slitaz\.org$" {
  server.name = "people"
  userdir.path = "Public"
  userdir.exclude-user = ("root")
  server.document-root = basedir + server.name
  server.errorlog = logdir + "people.slitaz.org-error.log"
  accesslog.filename = logdir + "people.slitaz.org-access.log"
}

# boot.slitaz.org
#
$HTTP["host"] =~ "boot\.slitaz\.org$" {
  server.name = "boot"
  server.document-root = basedir + server.name
  server.errorlog = logdir + "boot.slitaz.org-error.log"
  accesslog.filename = logdir + "boot.slitaz.org-access.log"
}

# pkgs.slitaz.org
#
$HTTP["host"] =~ "pkgs\.slitaz\.org$" {
  server.name = "pkgs"
  server.document-root = basedir + server.name
  server.errorlog = logdir + "pkgs.slitaz.org-error.log"
  accesslog.filename = logdir + "pkgs.slitaz.org-access.log"
  cgi.assign = (
    ".cgi" => "/bin/sh"
  )
}

# bb.slitaz.org (Build Bot)
#
$HTTP["host"] =~ "bb\.slitaz\.org$" {
  server.name = "bb"
  server.document-root = basedir + server.name
  server.errorlog = logdir + "bb.slitaz.org-error.log"
  accesslog.filename = logdir + "bb.slitaz.org-access.log"
}

# hg.slitaz.org (Mercurial repos)
#
$HTTP["host"] =~ "hg\.slitaz\.org$" {
  cgi.assign = (
    ".cgi" => "/usr/bin/python"
  )
  server.name = "hg"
  server.document-root = basedir + server.name
  url.rewrite-once = ( "(.*)" => "/hgwebdir.cgi$1" )
}

# repos.slitaz.org (Mercurial repos with auth and write access)
#
$HTTP["host"] =~ "repos\.slitaz\.org" {
  cgi.assign = (
    ".cgi" => "/usr/bin/python"
  )
  server.name = "hg"
  server.document-root = basedir + server.name
  url.rewrite-once = ( "(.*)" => "/hgwebdir.cgi$1" )
  auth.backend = "plain"
  auth.backend.plain.userfile = "/etc/lighttpd/plain.passwd"
  auth.require = ( "/" =>
    (
    "method" => "basic",
    "realm" => "SliTaz Mercurial repositories protected area",
    "require" => "valid-user"
    )
  )

}

# doc.slitaz.org
#
$HTTP["host"] =~ "doc\.slitaz\.org" {
  server.name = "doc"
  server.document-root = basedir + server.name
  index-file.names = ("doku.php") 
  var.dokudir = ""
   # Rewrites for dokuwiki
    url.rewrite = (
      "^" + var.dokudir + "/lib/.*$"              => "$0",
      "^" + var.dokudir + "/_media/(.*)?\?(.*)$"  => var.dokudir + "/lib/exe/fetch.php?media=$1&$2",
      "^" + var.dokudir + "/_media/(.*)$"         => var.dokudir + "/lib/exe/fetch.php?media=$1",
      "^" + var.dokudir + "/_detail/(.*)?\?(.*)$" => var.dokudir + "/lib/exe/detail.php?media=$1&$2",
      "^" + var.dokudir + "/_detail/(.*)?$"       => var.dokudir + "/lib/exe/detail.php?media=$1",
      "^" + var.dokudir + "/_export/([^/]+)/(.*)\?(.*)$" => var.dokudir + "/doku.php?do=export_$1&id=$2&$3",
      "^" + var.dokudir + "/_export/([^/]+)/(.*)" => var.dokudir + "/doku.php?do=export_$1&id=$2",
      "^" + var.dokudir + "/doku.php.*"           => "$0",
      "^" + var.dokudir + "/feed.php.*"           => "$0",
      "^" + var.dokudir + "/(.*)\?(.*)"           => var.dokudir + "/doku.php?id=$1&$2",
      "^" + var.dokudir + "/(.*)"                 => var.dokudir + "/doku.php?id=$1"
    )
}

